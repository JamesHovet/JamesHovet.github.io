<!DOCTYPE HTML>
<head>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <script src="scripts/d3.min.js"></script>
    <script src="scripts/Vibrant.min.js"></script>
    <script src="scripts/helpers.js"></script>
    <script src="scripts/draw.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link href="EightBarsStyles.css" rel="stylesheet">
</head>

<body>
    <!--Defs for SVG effects for every tile-->
    <svg width="0" height="0">
        <defs>
            <filter id="f1" x="0" y="0">
                <feGaussianBlur in="SourceGraphic" stdDeviation="6" />
                <feColorMatrix
                    type="matrix"
                    values=".3   0   0   0   0
                             0  .3   0   0   0
                             0   0  .3   0   0
                             0   0   0   1   0 "/>

            </filter>
        </defs>
    </svg>
</body>

<script>

    var hash = window.location.hash

    if(hash == ""){
        console.log("NO TOKEN")
        //TODO Fail gracefully
        hash = "#access_token=BQCCXf6Q3DS2gFOn6-5Ts7KPgVH2JZDbnQ1sMB46GcL3lFpLCb-95HpbWJtt8WaerawlSGtiFWnbki8VCZOJ7Bd5WtXZq5BvI4GLg1k9aCGKrsth2G8dYRVL6S3fYIU-LObvcuAHaTF9cl7aTaEzq9TUpO67laascfGWRXIL_aM4I4GGK9gUX1_wCF341vs_vaRjZWfZoN781R7y5rpxbXs6ZjoD9NGfXCOAhzilf4mFmhfotV0KhR-buEgjfAVECwyzrr0TpfifEqwp8Nc8qbIoKnDw49mQRK7KgsKiWBqmYakQdivFiw2nwSqdISmf3Q&token_type=Bearer&expires_in=3600"

    }

    //parse TOKEN
    var token = partsOfStr = hash.split('&')[0].substring(14);
    console.log(token)

    //get a playlist

    function getPlaylist(user,id) {
        $.ajax({
            url: "https://api.spotify.com/v1/users/"
            + user
            + "/playlists/"
            + id
            +"/tracks?fields=items(track(name,id,duration,external_urls,preview_url,album(name,images,external_urls),artists(name,external_urls)))&limit=100",
            headers: {
               'Authorization': 'Bearer ' + token
            },
            success: function(response) {
                handlePlaylist(response)
            }
        });
    }

    function testGetPlaylist() {
        getPlaylist("jrhovet","5iHCRy51LHHa68LnYPxf1X")
    }

    function handlePlaylist(res) {
        console.log(res)
        // getTrack(res.items[0].track,0)
        // createTileDiv(res.items[0].track,0)
        // createTileDiv(res.items[1].track,1)
        // createTileDiv(res.items[2].track,2)
        // createTileDiv(res.items[3].track,3)
        // createTileDiv(res.items[4].track,4)

        res.items.forEach(function(item,index) {
            createTileDiv(item.track,index)
        })

    }
    //TODO Fix
    testGetPlaylist()

    // var query = "Sympathy for the devil"
    // var query
    //
    // if(window.location.search != ""){
    //     query = window.location.search.substring(3)
    // } else {
    //     query = "Good times bad times celebration"
    // }

    // var query = "Good times bad times celebration"

    // $.ajax({
    //     url: 'https://api.spotify.com/v1/search?q=' + query + '&type=track',
    //     headers: {
    //        'Authorization': 'Bearer ' + token
    //     },
    //     success: function(response) {
    //         getTrack(response)
    //     }
    // });

    var testTrack

    function getTrackSpec(rawTrack) {
        testTrack = rawTrack
        // console.log(rawTrack)
        track = rawTrack

        this.t = {}

        // var id = track["id"]
        t.id = track["id"]
        t.current_url = track["album"]["images"][1]["url"]
        t.current_name = track["name"]
        t.current_durration = fancyTimeFormat(track["duration_ms"]/1000)
        t.current_album = track["album"]["name"]
        t.current_artist = track["artists"][0]["name"]
        t.current_href = track["external_urls"]["spotify"]
        t.current_album_href = track["album"]["external_urls"]["spotify"]
        t.current_artist_href = track["artists"][0]["external_urls"]["spotify"]
        return t
    }

    var clipPaths=[
        "M0,0 L 0,-100 L 100,-100  Z",
        "M0,0 L 100,0  L 100,-100  Z",
        "M0,0 L 100,0  L 100,100   Z",
        "M0,0 L 0,100  L 100,100   Z",
        "M0,0 L 0,100  L -100,100  Z",
        "M0,0 L -100,0 L -100,100  Z",
        "M0,0 L -100,0 L -100,-100 Z",
        "M0,0 L 0,-100 L -100,-100 Z"
    ]

    function createTileDiv(track,index) {
        this.div = $("<div>", {id: "svgDiv_" + index, class: "svgDiv"})
        this.svg = $("<svg width='300' height='300'>")
        div.append(this.svg)
        this.trackInfoDiv = $("<div class='trackInfo'>")
        this.trackInfoDiv.append($("<h1 class='songTitle'><a href='null'>Loading</a></h1>"))
        this.trackInfoDiv.append($("<h1 class='artist'><a href='null'>Loading</a></h1>"))
        this.trackInfoDiv.append($("<h1 class='albumTitle'><a href='null'>Loading</a></h1>"))

        this.div.append(this.trackInfoDiv)

        // console.log(track)
        $("body").append(div)

        this.t = getTrackSpec(track)
        console.log(t)

        getStatsAndDraw(this.t,index)

    }

    function getStatsAndDraw(t,index) {

        $.ajax({
                url: 'https://api.spotify.com/v1/audio-features/' + t.id,
                headers: {
                   'Authorization': 'Bearer ' + token
                },
                success: function(response) {
                    handleGetStats(response,t, index)
                }
            });
    }

    // function getStats(t,index) {
    //     $.ajax({
    //         url: 'https://api.spotify.com/v1/audio-features/' + t.id,
    //         headers: {
    //            'Authorization': 'Bearer ' + token
    //         },
    //         success: function(response) {
    //             handleGetStats(response, index)
    //         }
    //     });
    // }

    function handleGetStats(res,t, index) {
        // console.log(res)
        //values
        /*
        0: acousticness
        1: danceability
        2: energy
        3: liveness
        4: valence
        5: speechiness
        6: instrumentalness
        7: Key
        */

        this.data = [
            res["acousticness"],
            res["danceability"],
            res["energy"],
            res["liveness"],
            res["valence"],
            res["speechiness"],
            res["instrumentalness"],
            (res["key"] + 1)/13
        ]
        draw(t,index,this.data)
    }

    // testCreateTileDiv()

</script>
